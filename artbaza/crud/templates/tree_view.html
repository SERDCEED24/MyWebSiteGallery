<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–µ—Ä–∞—Ä—Ö–∏—è –º–æ–¥–µ–ª–µ–π</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .tree-toggle { cursor: pointer; font-weight: bold; }
        .tree-node { margin-left: 20px; display: none; }
        .context-menu { display: none; position: absolute; z-index: 1000; background: #fff; border: 1px solid #ccc; padding: 5px; }
        .context-menu ul { list-style: none; padding: 0; margin: 0; }
        .context-menu ul li { padding: 5px; cursor: pointer; }
        .context-menu ul li:hover { background: #f0f0f0; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light bg-gradient border-bottom">
    <div class="container-fluid">
        <a class="navbar-brand">–¢–∞–±–ª–∏—Ü—ã</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" aria-current="page"
                       href="/crud/Author/">–ê–≤—Ç–æ—Ä—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crud/Genre/">–ñ–∞–Ω—Ä—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crud/Material/">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crud/Technique/">–¢–µ—Ö–Ω–∏–∫–∏
                        –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crud/WorkStatus/">–°—Ç–∞—Ç—É—Å—ã
                        —Ä–∞–±–æ—Ç</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/crud/Artwork/">–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ
                        –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/crud/tree/">–î—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ</a>
                </li>
            </ul>
            <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </form>
        </div>
    </div>
</nav>
    <div class="container mt-4">
        <h2>–ò–µ—Ä–∞—Ä—Ö–∏—è –º–æ–¥–µ–ª–µ–π</h2>
        <ul class="list-unstyled">
            <li><span class="tree-toggle">üìö –ê–≤—Ç–æ—Ä—ã</span>
                <ul class="tree-node list-unstyled">
                    {% for author in authors %}
                        <li class="tree-item" data-type="Author" data-id="{{ author.id }}">{{ author }}
                            <ul>
                                {% for artwork in author.artwork_set.all %}
                                    <li class="tree-item" data-type="Artwork" data-id="{{ artwork.id }}">üñº {{ artwork.title }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
            <li><span class="tree-toggle">üé® –ñ–∞–Ω—Ä—ã</span>
                <ul class="tree-node list-unstyled">
                    {% for genre in genres %}
                        <li class="tree-item" data-type="Genre" data-id="{{ genre.id }}">{{ genre.genre_name }}
                            <ul>
                                {% for artwork in genre.artwork_set.all %}
                                    <li class="tree-item" data-type="Artwork" data-id="{{ artwork.id }}">üñº {{ artwork.title }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
            <li><span class="tree-toggle">üìú –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</span>
                <ul class="tree-node list-unstyled">
                    {% for material in materials %}
                        <li class="tree-item" data-type="Material" data-id="{{ material.id }}">{{ material.material_name }}
                        <ul>
                                {% for artwork in material.artwork_set.all %}
                                    <li class="tree-item" data-type="Artwork" data-id="{{ artwork.id }}">üñº {{ artwork.title }}</li>
                                {% endfor %}
                            </ul></li>
                    {% endfor %}
                </ul>
            </li>
            <li><span class="tree-toggle">üñå –¢–µ—Ö–Ω–∏–∫–∏</span>
                <ul class="tree-node list-unstyled">
                    {% for technique in techniques %}
                        <li class="tree-item" data-type="Technique" data-id="{{ technique.id }}">{{ technique.technique_name }}
                            <ul>
                                {% for artwork in technique.artwork_set.all %}
                                    <li class="tree-item" data-type="Artwork" data-id="{{ artwork.id }}">üñº {{ artwork.title }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
            <li><span class="tree-toggle">üîç –°—Ç–∞—Ç—É—Å—ã –∫–∞—Ä—Ç–∏–Ω</span>
                <ul class="tree-node list-unstyled">
                    {% for status in statuses %}
                        <li class="tree-item" data-type="WorkStatus" data-id="{{ status.id }}">{{ status.status_name }}
                            <ul>
                                {% for artwork in status.artwork_set.all %}
                                    <li class="tree-item" data-type="Artwork" data-id="{{ artwork.id }}">üñº {{ artwork.title }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </div>

    <div class="context-menu" id="context-menu">
        <ul>
            <li onclick="editItem()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</li>
            <li onclick="deleteItem()">üóë –£–¥–∞–ª–∏—Ç—å</li>
            <li onclick="addItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</li>
        </ul>
    </div>

    <script>
        document.querySelectorAll('.tree-toggle').forEach(item => {
            item.addEventListener('click', () => {
                let node = item.nextElementSibling;
                node.style.display = node.style.display === 'none' ? 'block' : 'none';
            });
        });

        document.addEventListener("contextmenu", function(event) {
            let target = event.target.closest('.tree-item');
            if (target) {
                event.preventDefault();
                let menu = document.getElementById("context-menu");
                menu.style.top = `${event.pageY}px`;
                menu.style.left = `${event.pageX}px`;
                menu.style.display = "block";
                menu.dataset.type = target.dataset.type;
                menu.dataset.id = target.dataset.id;
            }
        });

        document.addEventListener("click", () => {
            document.getElementById("context-menu").style.display = "none";
            window.location.href = relativePath;
        });

        function editItem() {
            let menu = document.getElementById("context-menu");
            window.location.href = `/crud/form/${menu.dataset.type}/${menu.dataset.id}/`;
        }

        function deleteItem() {
            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
            let menu = document.getElementById("context-menu");
            let target = document.querySelector(`[data-id="${menu.dataset.id}"][data-type="${menu.dataset.type}"]`);

            fetch(`/crud/delete_treenode/${menu.dataset.type}/${menu.dataset.id}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    target.remove(); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                } else {
                    alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + data.error);
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞:", error));
                }

        function addItem() {
            let menu = document.getElementById("context-menu");
            window.location.href = `/crud/form/${menu.dataset.type}/`;
        }
    </script>
</body>
</html>
